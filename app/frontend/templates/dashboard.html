<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rain-E Weather Assistant</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* Header with navigation */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { font-size: 2.5em; }
        .nav-buttons { display: flex; gap: 15px; }
        .nav-btn { background: rgba(255, 255, 255, 0.2); color: white; padding: 12px 24px; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; text-decoration: none; display: inline-block; transition: all 0.3s; }
        .nav-btn:hover { background: rgba(255, 255, 255, 0.35); transform: translateY(-2px); }
        .nav-btn.primary { background: #4CAF50; }
        .nav-btn.primary:hover { background: #45a049; }
        
        .location-info { text-align: center; margin-bottom: 20px; font-size: 0.9em; opacity: 0.8; }
        .weather-card { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 20px; padding: 30px; margin-bottom: 20px; }
        .current-weather { display: flex; justify-content: space-between; align-items: center; }
        .temp { font-size: 4em; font-weight: bold; }
        .events-section, .tasks-section { margin-top: 30px; }
        .event-item, .task-item { background: rgba(255, 255, 255, 0.15); padding: 15px; border-radius: 10px; margin-bottom: 10px; }
        .refresh-btn { background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .refresh-btn:hover { background: #45a049; }
        .update-location-btn { background: #2196F3; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; margin-left: 10px; }
        .update-location-btn:hover { background: #0b7dda; }
        
        .tracking-indicator { position: fixed; bottom: 20px; right: 20px; background: rgba(76, 175, 80, 0.9); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; display: none; }
        .tracking-indicator.active { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation Header -->
        <div class="header">
            <h1>üå¶Ô∏è Rain-E</h1>
            <div class="nav-buttons">
                <a href="/predict" class="nav-btn primary">üîÆ Long-Term Forecast</a>
                <a href="/settings" class="nav-btn">‚öôÔ∏è Settings</a>
            </div>
        </div>
        
        <p style="text-align: center; margin-bottom: 10px;">Welcome back, {{ profile.name }}!</p>
        <div class="location-info">
            üìç Location: {{ "%.4f"|format(location[0]) }}, {{ "%.4f"|format(location[1]) }}
            <button class="update-location-btn" onclick="updateLocation()">Update Location</button>
        </div>
        
        <!-- Current Weather -->
        <div class="weather-card">
            <div class="current-weather">
                <div>
                    <h2>Current Weather</h2>
                    <div class="temp" id="temperature">{{ weather.temperature }}¬∞C</div>
                    <p>Humidity: <span id="humidity">{{ weather.humidity }}%</span></p>
                    <p>Wind: <span id="wind">{{ weather.wind_speed }} m/s</span></p>
                    <p>Precipitation: <span id="precip">{{ weather.precipitation }} mm</span></p>
                </div>
                <button class="refresh-btn" onclick="refreshWeather()">Refresh</button>
            </div>
        </div>
        
        <!-- Calendar Events (Next 3 Days) -->
        <div class="events-section">
            <h2>üìÖ Upcoming Events (Next 3 Days)</h2>
            {% if events %}
                {% for event in events %}
                <div class="event-item">
                    <strong>{{ event.summary }}</strong><br>
                    <small>{{ event.datetime.strftime('%A, %B %d at %I:%M %p') }}</small><br>
                    {% if event.location %}
                    <small>üìç {{ event.location }}</small>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <p>No upcoming events</p>
            {% endif %}
        </div>
        
        <!-- Tasks (Next 2 Days) -->
        <div class="tasks-section">
            <h2>‚úÖ Tasks (Due in 2 Days)</h2>
            {% if tasks %}
                {% for task in tasks %}
                <div class="task-item">
                    <strong>{{ task.title }}</strong><br>
                    {% if task.due %}
                    <small>Due: {{ task.due.strftime('%A, %B %d') }}</small>
                    {% else %}
                    <small>No due date</small>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <p>No tasks due soon</p>
            {% endif %}
        </div>
    </div>
    
    <!-- Location Tracking Indicator -->
    <div class="tracking-indicator" id="trackingIndicator">
        üì° Location Tracking Active
    </div>
    
    <script>
        // Auto-refresh weather every 5 minutes
        setInterval(refreshWeather, 300000);
        
        function refreshWeather() {
            fetch('/api/weather/current')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('temperature').innerText = data.temperature + '¬∞C';
                    document.getElementById('humidity').innerText = data.humidity + '%';
                    document.getElementById('wind').innerText = data.wind_speed + ' m/s';
                    document.getElementById('precip').innerText = data.precipitation + ' mm';
                });
        }
        
        function updateLocation() {
            if (!navigator.geolocation) {
                alert("Geolocation is not supported by your browser");
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    fetch('/api/location/save', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        alert("Location updated! Refreshing page...");
                        location.reload();
                    });
                },
                function(error) {
                    alert("Failed to get location: " + error.message);
                }
            );
        }
        
        // Continuous location tracking
        let watchID = null;
        
        function startLocationTracking() {
            if (!navigator.geolocation) {
                console.log("Geolocation not supported");
                return;
            }
            
            // Show tracking indicator
            document.getElementById('trackingIndicator').classList.add('active');
            
            watchID = navigator.geolocation.watchPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    const accuracy = position.coords.accuracy;
                    
                    fetch('/api/location/track', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            latitude: lat,
                            longitude: lon,
                            accuracy: accuracy
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('üìç Location tracked:', data);
                        
                        if (data.predicted_destination) {
                            console.log('üéØ Predicted destination:', data.predicted_destination);
                        }
                    });
                },
                function(error) {
                    console.error('Location tracking error:', error);
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 30000,
                    timeout: 27000
                }
            );
            
            console.log('‚úÖ Location tracking started');
        }
        
        window.addEventListener('load', startLocationTracking);
    </script>
</body>
</html>
