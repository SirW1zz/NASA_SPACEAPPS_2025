<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Setup - Rain-E</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: #fff; 
            padding: 40px; 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container { 
            max-width: 500px; 
            background: rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(10px); 
            border-radius: 20px; 
            padding: 40px; 
            text-align: center;
        }
        h1 { margin-bottom: 20px; font-size: 2.5em; }
        p { margin-bottom: 30px; font-size: 1.1em; line-height: 1.6; }
        button { 
            width: 100%; 
            padding: 15px; 
            background: #4CAF50; 
            color: white; 
            border: none; 
            border-radius: 10px; 
            font-size: 18px; 
            cursor: pointer; 
            transition: 0.3s;
        }
        button:hover { background: #45a049; }
        button:disabled { background: #cccccc; cursor: not-allowed; }
        .status { 
            margin-top: 20px; 
            padding: 15px; 
            background: rgba(255, 255, 255, 0.2); 
            border-radius: 10px; 
            font-size: 14px;
        }
        .error { background: rgba(255, 0, 0, 0.3); }
        .success { background: rgba(0, 255, 0, 0.3); }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìç Location Setup</h1>
        <p>Rain-E needs your location to provide accurate weather forecasts and personalized recommendations for your area.</p>
        <p><strong>Your location is never shared</strong> and stays on your device.</p>
        
        <button id="getLocationBtn" onclick="getLocation()">Allow Location Access</button>
        
        <div id="status" class="status" style="display: none;"></div>
    </div>
    
    <script>
        function getLocation() {
            const statusDiv = document.getElementById('status');
            const btn = document.getElementById('getLocationBtn');
            
            if (!navigator.geolocation) {
                statusDiv.innerHTML = "‚ùå Geolocation is not supported by your browser.";
                statusDiv.className = "status error";
                statusDiv.style.display = "block";
                return;
            }
            
            btn.disabled = true;
            btn.innerText = "Getting Location...";
            statusDiv.innerHTML = "üì° Requesting location access...";
            statusDiv.className = "status";
            statusDiv.style.display = "block";
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;
                    const accuracy = position.coords.accuracy;
                    
                    // Send location to Flask backend
                    fetch('/api/location/save', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            latitude: latitude,
                            longitude: longitude
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            statusDiv.innerHTML = `‚úÖ Location saved! (Accuracy: ${Math.round(accuracy)}m)<br>Redirecting...`;
                            statusDiv.className = "status success";
                            
                            // Redirect to dashboard after 2 seconds
                            setTimeout(() => {
                                window.location.href = '/';
                            }, 2000);
                        } else {
                            statusDiv.innerHTML = "‚ùå Failed to save location. Please try again.";
                            statusDiv.className = "status error";
                            btn.disabled = false;
                            btn.innerText = "Retry";
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        statusDiv.innerHTML = "‚ùå Network error. Please check your connection.";
                        statusDiv.className = "status error";
                        btn.disabled = false;
                        btn.innerText = "Retry";
                    });
                },
                function(error) {
                    let errorMessage = "";
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = "‚ùå You denied location access. Rain-E needs your location to work properly.";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = "‚ùå Location information is unavailable. Please check your device settings.";
                            break;
                        case error.TIMEOUT:
                            errorMessage = "‚ùå Request timed out. Please try again.";
                            break;
                        default:
                            errorMessage = "‚ùå An unknown error occurred.";
                    }
                    statusDiv.innerHTML = errorMessage;
                    statusDiv.className = "status error";
                    btn.disabled = false;
                    btn.innerText = "Try Again";
                },
                {
                    enableHighAccuracy: true,  // Use GPS for better accuracy
                    timeout: 10000,            // 10 second timeout
                    maximumAge: 0              // Don't use cached position
                }
            );
        }
    </script>
</body>
</html>
